<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="Cal">

<select id="calendarlist" parameterType="ssg.com.maeil.dto.CalendarParam" resultType="ssg.com.maeil.dto.CalendarDto">
	select m.department_id, c.seq, c.employee_id, c.title, c.content, c.rdate, c.wdate, c.share, m.auth
	from maeil_member m 
	join (select seq, employee_id, title, content, rdate, wdate, share
			from (select row_number()over(partition by substr(rdate, 1, 8)
		  						order by rdate asc) as rnum, seq, employee_id, title, content, rdate, wdate, share		  
							from maeil_department_calendar
					where substr(rdate, 1, 6)=#{yyyyMM}) a
			where rnum between 1 and 3
	 ) c on m.employee_id = c.employee_id
	 <if test="auth ==3">	
		where (m.department_id= #{department_id} and share != 2)
	</if>			
</select>

<insert id="calwrite" parameterType="ssg.com.maeil.dto.CalendarDto">
	insert into maeil_department_calendar(seq, employee_id, title, content, rdate, wdate, share)
	values(#{seq}, #{employee_id}, #{title}, #{content}, #{rdate}, now(), #{share})
</insert>

<select id="getcalendarlist" parameterType="ssg.com.maeil.dto.CalendarParam" resultType="ssg.com.maeil.dto.CalendarDto">
	select m.department_id, c.seq, c.employee_id, c.title, c.content, c.rdate, c.wdate, c.share, m.auth
	from maeil_member m 
	join (select row_number()over(partition by substr(rdate, 1, 8)
		  						order by rdate asc) as rnum, seq, employee_id, title, content, rdate, wdate, share		  
		  		from maeil_department_calendar
		  		where substr(rdate, 1, 8)=#{yyyyMMdd}) c
		on m.employee_id = c.employee_id
		<if test="auth == 3 ">
			where (m.department_id= #{department_id} and share != 2) and rnum between 1 and 3
		</if>	
</select>

<select id="caldetail" parameterType="java.lang.Integer" resultType="ssg.com.maeil.dto.CalendarDto">
	select seq, employee_id, title, content, rdate, wdate, share
	from maeil_department_calendar
	where seq=#{seq}
</select>

<select id="caldaylist" parameterType="ssg.com.maeil.dto.CalendarParam" resultType="ssg.com.maeil.dto.CalendarDto">
	select m.department_id, c.seq, c.employee_id, c.title, c.content, c.rdate, c.wdate, c.share, m.auth
	from maeil_member m join maeil_department_calendar c
		on m.employee_id = c.employee_id		
	<if test="auth == 3 ">
		where (m.department_id= #{department_id} and share != 2) and substring(#{rdate},1,8)=#{yyyyMMdd}		
	</if>	
</select>

<update id="calupdateAf" parameterType="ssg.com.maeil.dto.CalendarDto">
	update maeil_department_calendar
	set employee_id=#{employee_id}, title=#{title}, content=#{content}, rdate=#{rdate}, wdate=now(), share=#{share}
	where seq=#{seq}
</update>

<delete id="caldelete" parameterType="ssg.com.maeil.dto.CalendarParam">	
	delete c
	from maeil_department_calendar as c
	INNER JOIN maeil_member as m
	on m.employee_id = c.employee_id
	where seq=#{seq}			
		<if test="auth == 3">
			and employee_id=#{employee_id}	
		</if>
</delete>


</mapper>












